---
layout: single
title: "ê²Œì‹œíŒ í”„ë¡œì íŠ¸-  í•´ì‹œíƒœê·¸ ê²€ìƒ‰ í˜ì´ì§€ êµ¬í˜„"
categories: spring
tags: [java, spring]
sidebar:
    nav: "counts"
---

 í•´ì‹œíƒœê·¸ ë§Œ ë”°ë¡œ ë³¼ ìˆ˜ ìˆëŠ” ê²€ìƒ‰ í˜ì´ì§€ë¥¼ êµ¬í˜„í•˜ë ¤ê³  í•œë‹¤. 



# 1. ì„œë¹„ìŠ¤ êµ¬í˜„

## í…ŒìŠ¤íŠ¸

`ArticleServiceTest` ì— í…ŒìŠ¤íŠ¸ ì¶”ê°€

```java
//  í•´ì‹œíƒœê·¸ ê²€ìƒ‰ í˜ì´ì§€ êµ¬í˜„ í…ŒìŠ¤íŠ¸
// ê²€ìƒ‰ì–´ ì—†ëŠ” ê²½ìš°
@DisplayName("ê²€ìƒ‰ì–´ ì—†ì´ ê²Œì‹œê¸€ì„ í•´ì‹œíƒœê·¸ ê²€ìƒ‰í•˜ë©´, ë¹ˆ í˜ì´ì§€ë¥¼ ë°˜í™˜í•œë‹¤.")
@Test
void givenNoSearchParameters_whenSearchingArticlesViaHashtag_thenReturnsEmptyPage(){
    //  Given
    Pageable pageable = Pageable.ofSize(20);

    //  When
    Page<ArticleDto> articles =  sut.searchArticlesViaHashtag(null, pageable);
    // null ì‚¬ìš©í•œ ì´ìœ ëŠ” ì•„ì§ ê°’ì„ ì •í•´ì£¼ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì„ 

    //  Then
    assertThat(articles).isEqualTo(Page.empty(pageable));
    then(articleRepository).shouldHaveNoInteractions();
}

// ê²€ìƒ‰ì–´ ìˆëŠ” ê²½ìš°
@DisplayName("ê²Œì‹œê¸€ì„ í•´ì‹œíƒœê·¸ ê²€ìƒ‰í•˜ë©´, ê²Œì‹œê¸€ í˜ì´ì§€ë¥¼ ë°˜í™˜í•œë‹¤.")
    @Test
    void givenHashtag_whenSearchingArticlesViaHashtag_thenReturnsArticlesPage(){
        //  Given
        String hashtag = "#java";   //  í•´ì‹œíƒœê·¸ ê°’ ì¶”ê°€
        Pageable pageable = Pageable.ofSize(20);
        given(articleRepository.findByHashtag(hashtag, pageable)).willReturn(Page.empty(pageable));  //  í•´ì‹œíƒœê·¸, pageable ì •ë³´ ì €ì¥

        //  When
        Page<ArticleDto> articles =  sut.searchArticlesViaHashtag(hashtag, pageable);

        //  Then
        assertThat(articles).isEqualTo(Page.empty(pageable));
        then(articleRepository).should().findByHashtag(hashtag, pageable);
    }
```



`searchArticlesViaHashtag` ë©”ì†Œë“œë¥¼ ìƒì„±í•´ ì£¼ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ìƒì„±í•´ì£¼ì!



ì´ê¹Œì§€ í…ŒìŠ¤íŠ¸ë¥¼ ìƒì„±í–ˆë‹¤ë©´, ìš°ë¦¬ëŠ” í•´ì‹œíƒœê·¸ë¥¼ ì¡°íšŒí•˜ë©´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•´ì£¼ê³  ì‹¶ê¸° ë•Œë¬¸ì— í•˜ë‚˜ì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ë” ìƒì„±í•œë‹¤. 

```java
@DisplayName("í•´ì‹œíƒœê·¸ë¥¼ ì¡°íšŒí•˜ë©´, ìœ ë‹ˆí¬ í•´ì‹œíƒœê·¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•œë‹¤.")
    @Test
    void givenNothing_whenCalling_thenReturnsHashTags(){
        // Given
       List<String> expectedHashtags = List.of("#java","#spring","#boot");
       given(articleRepository.findAllDistinctHashtags()).willReturn(expectedHashtags);

        // When
        List<String> actualHashtags = sut.getHashtags();
        // Then

        assertThat(actualHashtags).isEqualTo(expectedHashtags);
        then(articleRepository).should().findAllDistinctHashtags();
    }
```

ë¨¼ì € ì˜ˆìƒë˜ëŠ” í•´ì‹œíƒœê·¸ ë¦¬ìŠ¤íŠ¸ì˜ í˜•íƒœë¥¼ ì •ì˜í•˜ê³ , í•´ë‹¹ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¦¬í„´í•´ì£¼ëŠ” ë©”ì†Œë“œì¸ `findAllDistinctHashtags`ì‘ì„±í•œë‹¤.

getHashtags()ë¥¼ í†µí•´ ë‚˜íƒ€ë‚œ ë¦¬ìŠ¤íŠ¸ë¥¼ `actualHashtags`ë¡œ ì •ì˜í•˜ê³  í•´ë‹¹ ê°’ì„ `expectedHashtags`ì™€ ë¹„êµí•œë‹¤.

ì¿¼ë¦¬ ì¶œë ¥ê²°ê³¼ê°€ ë„ë©”ì¸ì´ ì•„ë‹Œ ë¬¸ìì—´ì„ í•„ìš”ë¡œ í•œë‹¤. ìŠ¤í”„ë§ ë°ì´í„° jpaì˜ ì¿¼ë¦¬ë©”ì†Œë“œëŠ” ë„ë©”ì¸ìœ¼ë¡œ ì¶œë ¥ì„ ë§Œë“¤ì–´ì¤€ë‹¤. ì´ë¥¼ìœ„í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ querydslì´ë‹¤.

repository ê²½ë¡œì—ì„œ querydsl íŒ¨í‚¤ì§€ë¥¼ ë§Œë“¤ê³  ë‚´ë¶€ì— ArticleRepositoryCustom, ArticleRepositoryCustomImplì„ ìƒì„±í•œë‹¤.

ğŸš¨ ImplíŒŒì¼ì€ querydslì´ ì¸ì‹í•˜ëŠ” íŒŒì¼ì´ë‹¤. ë”°ë¼ì„œ ì´ë¦„ì„ í•¨ë¶€ë¡œ ë°”ê¾¸ë©´ ì•ˆëœë‹¤.

`ArticleRepositoryCustom`

```java
package com.ancho.crud.repository.querydsl;

import java.util.List;

public interface ArticleRepositoryCustom {
    List<String> findAllDistinctHashtags(); //  ëª¨ë“  í•´ì‹œíƒœê·¸ë¥¼ ë½‘ëŠ” ë¦¬ìŠ¤íŠ¸

}

```



`ArticleRepositoryCustomImpl`

```java
package com.ancho.crud.repository.querydsl;

import com.ancho.crud.domain.Article;
import com.ancho.crud.domain.QArticle;
import com.querydsl.jpa.impl.JPAQuery;
import org.springframework.data.jpa.repository.support.QuerydslRepositorySupport;

import java.util.List;

public class ArticleRepositoryCustomImpl extends QuerydslRepositorySupport implements ArticleRepositoryCustom {

    public ArticleRepositoryCustomImpl() {
        super(Article.class);
    }

    @Override
    public List<String> findAllDistinctHashtags() {
        QArticle article = QArticle.article;

        return from(article)
                .distinct() // í•´ì‹œíƒœê·¸ëŠ” ì¤‘ë³µì´ ë§ê¸° ë•Œë¬¸ì— distinctë¥¼ ì‚¬ìš©í•¨
                .select(article.hashtag)
                .where(article.hashtag.isNotNull())
                .fetch();
    }
}
```

ArticleRepositoryì™€ ì—°ë™ì„ ì‹œì¼œì•¼ í•˜ë¯€ë¡œ extendsì— ArticleRepositoryCustomì„ ì¶”ê°€í•´ì¤˜ì•¼í•œë‹¤.

`ArticleRepository` ìˆ˜ì •

```java
public interface ArticleRepository extends
        JpaRepository<Article, Long>,
        ArticleRepositoryCustom,	//	ì¶”ê°€
        QuerydslPredicateExecutor<Article>,
        QuerydslBinderCustomizer<QArticle> {
```



## ì„œë¹„ìŠ¤

`ArticleService`

```java
@Transactional(readOnly = true)
public Page<ArticleDto> searchArticlesViaHashtag(String hashtag, Pageable pageable) {
    if(hashtag == null || hashtag.isBlank()){
        //	í•´ì‹œíƒœê·¸ê°€ ì—†ê±°ë‚˜ ë¹ˆ ê³µê°„ì´ë¼ë©´ í˜ì´ì§€ì— ì•„ë¬´ê²ƒë„ ë³´ë‚´ì£¼ì§€ ì•ŠìŒ 
        return Page.empty(pageable);
    }
	//	í•´ì‹œíƒœê·¸ê°€ ìˆì„ ê²½ìš°ì—ë§Œ ë³´ì—¬ì¤Œ 
    return articleRepository.findByHashtag(hashtag, pageable).map(ArticleDto::from());
}

public List<String> getHashtags() {
    // ì €ì¥ëœ í•´ì‹œíƒœê·¸ ê°’ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜ 
    return articleRepository.findAllDistinctHashtags();
}
```



# 2. ì»¨íŠ¸ë¡¤ëŸ¬ êµ¬í˜„

## ë§¤í•‘

í•´ì‹œíƒœê·¸ë¥¼ ê²€ìƒ‰ì–´ë¡œ í•˜ëŠ” ê²€ìƒ‰í˜ì´ì§€ë¥¼ ë”°ë¡œ ë§Œë“ ë‹¤. 



`ArticleController`

```java
// í•´ì‹œíƒœê·¸ í˜ì´ì§€
@GetMapping("/search-hashtag")
public String searchHashtag(
        @RequestParam(required = false) String searchValue,
        @PageableDefault(size = 10, sort = "createdAt", direction = Sort.Direction.DESC) Pageable pageable,
        ModelMap map
){
    return "articles/search-hashtag";
}
```



`ArticleControllerTest`

```java
@DisplayName("[view][GET] ê²Œì‹œê¸€ í•´ì‹œíƒœê·¸ ê²€ìƒ‰ í˜ì´ì§€ - ì •ìƒ í˜¸ì¶œ, í•´ì‹œíƒœê·¸ ì…ë ¥")
@Test
public void givenHashtag_whenRequestingArticleHashtagSearchView_thenReturnsArticleSearchHashtagView() throws Exception {
    //  Given
    String hashtag = "#java";
    given(articleService.searchArticlesViaHashtag(eq(hashtag), any(Pageable.class))).willReturn(Page.empty());
    //  When & Then
    mvc.perform(get("/articles/search-hashtag")
                    .queryParam("searchValue", hashtag)
            )
            .andExpect(status().isOk()) //  ì •ìƒ í˜¸ì¶œ
            .andExpect(content().contentTypeCompatibleWith(MediaType.TEXT_HTML))  //  ë°ì´í„° í™•ì¸
            .andExpect(view().name("articles/search-hashtag"))   //  ë·° ì´ë¦„ ê²€ì‚¬
            .andExpect(model().attribute("articles", Page.empty()))
            .andExpect(model().attributeExists("hashtags"))
            .andExpect(model().attributeExists("paginationBarNumbers"));

    then(articleService).should().searchArticlesViaHashtag(eq(hashtag), any(Pageable.class));
}
```



ì´ì œ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ êµ¬í˜„í•´ ë³´ê² ë‹¤.

`ArticleController`

```java
 // í•´ì‹œíƒœê·¸ í˜ì´ì§€
    @GetMapping("/search-hashtag")
    public String searchHashtag(
            @RequestParam(required = false) String searchValue,
            @PageableDefault(size = 10, sort = "createdAt", direction = Sort.Direction.DESC) Pageable pageable,
            ModelMap map
    ){
        // í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜´
        Page<ArticleResponse> articles = articleService.searchArticlesViaHashtag(searchValue, pageable).map(ArticleResponse::from);
        //  í˜ì´ì§€ë„¤ì´ì…˜ barNumbers ëŠ” í˜ì´ì§€ë„¤ì´ì…˜ ì„œë¹„ìŠ¤ ì•ˆì— ì¡´ì¬í•˜ëŠ” getPaginationBarNumbers(í˜„ì¬ í˜ì´ì§€, ì „ì²´ í˜ì´ì§€) í•¨ìˆ˜ë¥¼ ì´ìš©í•´ êµ¬í•  ìˆ˜ ìˆë‹¤.
        List<Integer> barNumbers = paginationService.getPaginationBarNumbers(pageable.getPageNumber(), articles.getTotalPages());
        List<String> hashtags = articleService.getHashtags();


        map.addAttribute("articles", articles);
        map.addAttribute("hashtags", hashtags);
        map.addAttribute("paginationBarNumbers", barNumbers);
//        map.addAttribute("searchTypes",SearchType.values());

        return "articles/search-hashtag";
    }
```



`test`

```java
@DisplayName("[view][GET] ê²Œì‹œê¸€ í•´ì‹œíƒœê·¸ ê²€ìƒ‰ í˜ì´ì§€ - ì •ìƒ í˜¸ì¶œ, í•´ì‹œíƒœê·¸ ì…ë ¥")
@Test
public void givenHashtag_whenRequestingArticleHashtagSearchView_thenReturnsArticleSearchHashtagView() throws Exception {
    //  Given
    String hashtag = "#java";
    given(articleService.searchArticlesViaHashtag(eq(hashtag), any(Pageable.class))).willReturn(Page.empty());
    //  When & Then
    mvc.perform(get("/articles/search-hashtag")
                    .queryParam("searchValue", hashtag)
            )
            .andExpect(status().isOk()) //  ì •ìƒ í˜¸ì¶œ
            .andExpect(content().contentTypeCompatibleWith(MediaType.TEXT_HTML))  //  ë°ì´í„° í™•ì¸
            .andExpect(view().name("articles/search-hashtag"))   //  ë·° ì´ë¦„ ê²€ì‚¬
            .andExpect(model().attribute("articles", Page.empty()))
            .andExpect(model().attributeExists("hashtags"))
            .andExpect(model().attributeExists("paginationBarNumbers"));

    then(articleService).should().searchArticlesViaHashtag(eq(hashtag), any(Pageable.class));
}
```



# 3. ë·° ê¸°ëŠ¥ ì¶”ê°€

`search-hashtag.html`

```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í•´ì‹œíƒœê·¸ ê²€ìƒ‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Ancho">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/articles/table-header.css">
</head>
<body>

<header id="header">
    í—¤ë” ì‚½ì…ë¶€
    <hr>
</header>
<main class="container">
    <header class="py-5 text-center">
        <h1>Hashtags</h1>
    </header>

    <section class="row d-flex justify-content-center">
        <div id="hashtags" class="col-9 d-flex flex-wrap justify-content-evenly">
            <div class="p-2">
                <h2 class="text-center 1h-lg font-monospace"><a href="#">#java</a></h2>
            </div>
        </div>
    </section>

    <hr>

    <table class="table" id="article-table">
        <thead>
        <tr>
            <th class="title col-6"><a>ì œëª©</a></th>
            <th class="content col-4"><a>ë³¸ë¬¸</a></th>
            <th class="user-id"><a>ì‘ì„±ì</a></th>
            <th class="created-at"><a>ì‘ì„±ì¼</a></th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td class="title"><a>ì²«ê¸€</a></td>
            <td class="content"><span class="d-inline-block text-truncate" style="max-width:300px;">ë³¸ë¬¸</span></td>
            <td class="user-id">Jyc</td>
            <td class="created-at">
                <time>2022-01-01</time>
            </td>
        </tr>
        <tr>
            <td>ë‘ë²ˆì§¸ê¸€</td>
            <td>#spring</td>
            <td>Uno</td>
            <td>
                <time>2022-01-02</time>
            </td>
        </tr>
        <tr>
            <td>ì„¸ë²ˆì§¸ê¸€</td>
            <td>#java</td>
            <td>Uno</td>
            <td>
                <time>2022-01-03</time>
            </td>
        </tr>
        </tbody>
    </table>


    <nav id="pagination" aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item"><a class="page-link" href="#">Previous</a></li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">Next</a></li>
        </ul>
    </nav>


</main>
<footer id="footer">
    <hr>
    í‘¸í„° ì‚½ì…ë¶€
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
        crossorigin="anonymous"></script>
</body>
</html>
```



`search-hashtag.th.xml`

```xml
<?xml version="1.0"?>
<thlogic xmlns:th="http://www.thymeleaf.org">
    <attr sel="#header" th:replace="header :: header"/>
    <attr sel="#footer" th:replace="footer :: footer"/>
    <attr sel="main" th:object="${articles}">

        <attr sel="#hashtags" th:remove="all-but-first">
            <attr sel="div" th:each="hashtag : ${hashtags}">
                <attr sel="a" th:class="'text-reset'" th:text="${hashtag}" th:href="@{/articles/search-hashtag(
                    page=${param.page},
                    sort=${param.sort},
                    searchType=${searchType.name},
                    searchValue=${hashtag}
                )}"/>
            </attr>
        </attr>

        <attr sel="#article-table">
            <attr sel="thead/tr">
                <attr sel="th.title/a" th:text="ì œëª©" th:href="@{/articles/search-hashtag(
                page=${articles.number},
                sort='title' + (*{sort.getOrderFor('title')} != null ? (*{sort.getOrderFor('title').direction.name} != 'DESC' ? ',desc' : '') : ''),
                searchType=${searchType.name},
                searchValue=${param.searchValue}
                )}"/>
                <attr sel="th.content/a" th:text="ë³¸ë¬¸" th:href="@{/articles/search-hashtag(
                page=${articles.number},
                sort='content' + (*{sort.getOrderFor('content')} != null ? (*{sort.getOrderFor('content').direction.name} != 'DESC' ? ',desc' : '') : ''),
                searchType=${searchType.name},
                searchValue=${param.searchValue}
                )}"/>
                <attr sel="th.user-id/a" th:text="ì‘ì„±ì" th:href="@{/articles/search-hashtag(
                page=${articles.number},
                sort='userAccount.userId' + (*{sort.getOrderFor('userAccount.userId')} != null ? (*{sort.getOrderFor('userAccount.userId').direction.name} != 'DESC' ? ',desc' : '') : ''),
                searchType=${searchType.name},
                searchValue=${param.searchValue}
                )}"/>
                <attr sel="th.created-at/a" th:text="ì‘ì„±ì¼" th:href="@{/articles/search-hashtag(
                page=${articles.number},
                sort='createdAt' + (*{sort.getOrderFor('createdAt')} != null ? (*{sort.getOrderFor('createdAt').direction.name} != 'DESC' ? ',desc' : '') : ''),
                searchType=${searchType.name},
                searchValue=${param.searchValue}
                )}"/>
            </attr>

            <attr sel="tbody" th:remove="all-but-first">
                <attr sel="tr[0]" th:each="article : ${articles}">
                    <attr sel="td.title/a" th:text="${article.title}" th:href="@{'/articles/' + ${article.id}}"/>
                    <attr sel="td.content/span" th:text="${article.content}"/>
                    <attr sel="td.user-id" th:text="${article.nickname}"/>
                    <attr sel="td.created-at/time" th:datetime="${article.createdAt}"
                          th:text="${#temporals.format(article.createdAt, 'yyyy-MM-dd')}"/>
                </attr>
            </attr>
        </attr>
        <attr sel="#pagination">
            <attr sel="li[0]/a"
                  th:text="'previous'"
                  th:href="@{/articles/search-hashtag(page=${articles.number - 1},searchType=${searchType.name},searchValue=${param.searchValue})}"
                  th:class="'page-link' + (${articles.number} <= 0 ? ' disabled' : '' )"
            />
            <attr sel="li[1]" th:class="page-item" th:each="pageNumber : ${paginationBarNumbers}">
                <attr sel="a"
                      th:text="${pageNumber + 1}"
                      th:href="@{/articles/search-hashtag(page=${pageNumber},searchType=${searchType.name},searchValue=${param.searchValue})}"
                      th:class="'page-link' + (${pageNumber} == ${articles.number} ? ' disabled' : '')"
                />
            </attr>
            <attr sel="li[2]/a"
                  th:text="'next'"
                  th:href="@{/articles/search-hashtag(page=${articles.number + 1},searchType=${searchType.name},searchValue=${param.searchValue})}"
                  th:class="'page-link' + (${articles.number} >= ${articles.totalPages -1} ? ' disabled' : '')"
            />

        </attr>

    </attr>
</thlogic>
```



### ğŸ“· ê²°ê³¼

![image-20230916183727507]({{site.url}}/images/2023-09-16-backend12/image-20230916183727507.png)



í•´ì‹œíƒœê·¸ë¥¼ ëˆ„ë¥´ë©´ ê²Œì‹œê¸€ì— í•´ë‹¹í•˜ëŠ” í•´ì‹œíƒœê·¸ë¥¼ ê²Œì‹œíŒ í˜•ì‹ìœ¼ë¡œ ë³´ì—¬ì¤€ë‹¤. 
